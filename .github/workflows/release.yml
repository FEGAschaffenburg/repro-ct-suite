name: Build and publish release

# Automatisches Release bei Version-Tags
on:
  workflow_dispatch: # Auch manuell ausf√ºhrbar
  push:
    tags:
      - 'v*.*.*.*'
      - 'v*.*.*'

jobs:
  build-and-publish:
    name: Build ZIP and publish release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure scripts are executable
        run: |
          chmod +x scripts/*.sh || true

      - name: Create release ZIP (normalize entries)
        run: |
          echo "GITHUB_REF_NAME is: $GITHUB_REF_NAME"
          # Strip leading 'v' for version argument
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Creating ZIP for version: $VERSION"
          ./scripts/create-release-zip.sh "$VERSION"

      - name: Create GitHub Release with ZIP
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ZIP_FILE="repro-ct-suite-${VERSION}-fs.zip"
          
          # Create release and upload asset
          gh release create "$GITHUB_REF_NAME" \
            "$ZIP_FILE" \
            --title "$GITHUB_REF_NAME" \
            --notes "Automated release for $GITHUB_REF_NAME"
